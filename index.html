<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumina School TTM | TimeTable Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --glass: rgba(15, 23, 42, 0.7); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f8fafc; }
        .bg-gradient { background: radial-gradient(circle at top right, #1e1b4b, #020617); }
        .glass-ui { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .btn-primary { background: #4f46e5; transition: all 0.3s ease; }
        .btn-primary:hover { background: #6366f1; transform: translateY(-2px); box-shadow: 0 10px 20px -10px #4f46e5; }
        .developer-footer { font-size: 10px; letter-spacing: 2px; opacity: 0.4; text-transform: uppercase; text-align: center; padding: 20px; }
    </style>
</head>
<body class="bg-gradient min-h-screen">

    <div id="auth-container" class="min-h-screen flex items-center justify-center p-6">
        <div class="glass-ui w-full max-w-[400px] rounded-[32px] p-10 shadow-2xl">
            <div class="text-center mb-10">
                <i data-lucide="zap" class="w-10 h-10 text-indigo-400 mx-auto mb-4"></i>
                <h1 class="text-2xl font-bold tracking-tight">Lumina TTM</h1>
                <p class="text-slate-400 text-sm">Educational Resource Architect</p>
            </div>

            <div class="flex bg-white/5 p-1 rounded-2xl mb-8">
                <button onclick="toggleAuth('login')" id="tab-login" class="flex-1 py-2 rounded-xl text-sm font-bold bg-indigo-600">Login</button>
                <button onclick="toggleAuth('register')" id="tab-register" class="flex-1 py-2 rounded-xl text-sm font-bold text-slate-400">Register</button>
            </div>

            <form id="auth-form" onsubmit="processAuth(event)" class="space-y-4">
                <div id="register-fields" class="hidden space-y-4">
                    <select id="role" onchange="updateRegUI()" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl outline-none focus:border-indigo-500">
                        <option value="teacher">Register as Teacher</option>
                        <option value="manager">Register as Manager</option>
                        <option value="principal">Register as Principal (New School)</option>
                    </select>
                    <input type="text" id="fullname" placeholder="Full Name" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl outline-none">
                    <input type="text" id="school_name" placeholder="School Name" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl outline-none hidden">
                    <input type="text" id="v_code" placeholder="Verification Code" class="w-full bg-amber-500/10 border border-amber-500/20 p-3 rounded-xl outline-none text-amber-200">
                </div>

                <input type="email" id="email" placeholder="Email Address" required class="w-full bg-white/5 border border-white/10 p-3 rounded-xl outline-none">
                <input type="password" id="password" placeholder="Password" required class="w-full bg-white/5 border border-white/10 p-3 rounded-xl outline-none">
                
                <button type="submit" id="submit-btn" class="w-full btn-primary py-4 rounded-xl font-bold mt-4">Sign In</button>
            </form>

            <div class="developer-footer">Developer by K.A.V.Rashmika</div>
        </div>
    </div>

    <div id="app-container" class="hidden h-screen flex">
        <aside class="w-72 glass-ui border-y-0 border-l-0 flex flex-col">
            <div class="p-8">
                <div class="flex items-center gap-3 mb-8">
                    <div class="p-2 bg-indigo-600 rounded-lg"><i data-lucide="component" class="w-5 h-5"></i></div>
                    <span class="font-bold text-xl">Lumina</span>
                </div>
                <div id="school-info" class="p-4 bg-white/5 rounded-2xl border border-white/5">
                    <p id="display-school" class="text-xs font-bold text-indigo-400 uppercase mb-1"></p>
                    <p id="display-user" class="text-sm opacity-70 truncate"></p>
                </div>
            </div>

            <nav class="flex-1 px-6 space-y-2" id="nav-links">
                </nav>

            <div class="p-8">
                <button onclick="signOut()" class="flex items-center gap-3 text-slate-400 hover:text-red-400 transition mb-4">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Sign Out
                </button>
                <div class="developer-footer !p-0 !text-left">Developer by K.A.V.Rashmika</div>
            </div>
        </aside>

        <main class="flex-1 p-10 overflow-y-auto">
            <div id="content-header" class="flex justify-between items-center mb-10">
                <h2 id="view-title" class="text-3xl font-bold">Dashboard</h2>
                <div id="view-actions"></div>
            </div>
            <div id="view-content" class="glass-ui rounded-[32px] p-8 min-h-[500px]"></div>
            <div class="developer-footer">Developer by K.A.V.Rashmika</div>
        </main>
    </div>

    <script>
        // --- CREDENTIALS ---
        const SB_URL = 'https://yybyyiyrquxtnczrbvgb.supabase.co';
        const SB_KEY = 'sb_publishable_Kjio-fMoDlUy5Oc0dvbH6g_HMqBX9qM';
        const supabase = window.supabase.createClient(SB_URL, SB_KEY);

        let isLogin = true;
        let userProfile = null;

        // --- AUTH LOGIC ---
        function toggleAuth(mode) {
            isLogin = mode === 'login';
            document.getElementById('tab-login').className = isLogin ? 'flex-1 py-2 rounded-xl text-sm font-bold bg-indigo-600' : 'flex-1 py-2 rounded-xl text-sm font-bold text-slate-400';
            document.getElementById('tab-register').className = !isLogin ? 'flex-1 py-2 rounded-xl text-sm font-bold bg-indigo-600' : 'flex-1 py-2 rounded-xl text-sm font-bold text-slate-400';
            document.getElementById('register-fields').classList.toggle('hidden', isLogin);
            document.getElementById('submit-btn').innerText = isLogin ? 'Sign In' : 'Create Account';
        }

        function updateRegUI() {
            const role = document.getElementById('role').value;
            document.getElementById('school_name').classList.toggle('hidden', role !== 'principal');
            document.getElementById('v_code').classList.toggle('hidden', role === 'principal');
        }

        async function processAuth(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (isLogin) {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) return alert(error.message);
            } else {
                const role = document.getElementById('role').value;
                const name = document.getElementById('fullname').value;
                let s_id = null;

                if (role !== 'principal') {
                    const code = document.getElementById('v_code').value;
                    const { data: check } = await supabase.rpc('get_school_by_code', { input_code: code });
                    if (!check || check.length === 0) return alert("Invalid Verification Code!");
                    s_id = check[0].s_id;
                }

                const { data: auth, error: aErr } = await supabase.auth.signUp({ email, password });
                if (aErr) return alert(aErr.message);

                if (role === 'principal') {
                    const s_name = document.getElementById('school_name').value;
                    const { data: s_data } = await supabase.from('schools').insert({ name: s_name }).select().single();
                    s_id = s_data.id;
                }

                const { error: pErr } = await supabase.from('profiles').insert({
                    id: auth.user.id,
                    email,
                    full_name: name,
                    role,
                    school_id: s_id
                });
                
                if (pErr) return alert("Profile Error: " + pErr.message);
                alert("Account created! You can now log in.");
                toggleAuth('login');
                return;
            }
            checkUser();
        }

        async function checkUser() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                const { data: profile } = await supabase.from('profiles').select('*, schools(name)').eq('id', user.id).single();
                if (profile) {
                    userProfile = profile;
                    showApp();
                }
            }
        }

        function showApp() {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('display-school').innerText = userProfile.schools.name;
            document.getElementById('display-user').innerText = userProfile.full_name;
            
            const nav = document.getElementById('nav-links');
            nav.innerHTML = `<button onclick="renderDashboard()" class="w-full flex items-center gap-3 p-4 rounded-2xl bg-indigo-600/20 text-indigo-400 font-bold"><i data-lucide="layout-dashboard"></i> Dashboard</button>`;
            
            if (userProfile.role === 'principal') {
                nav.innerHTML += `<button onclick="renderCodes()" class="w-full flex items-center gap-3 p-4 rounded-2xl hover:bg-white/5 transition"><i data-lucide="key"></i> Manage Codes</button>`;
            }
            lucide.createIcons();
            renderDashboard();
        }

        // --- PRINCIPAL CODE GENERATION ---
        async function renderCodes() {
            document.getElementById('view-title').innerText = "Verification Codes";
            document.getElementById('view-actions').innerHTML = `<button onclick="generateNewCode()" class="btn-primary px-6 py-2 rounded-xl text-sm font-bold">Generate Code</button>`;
            
            const { data: codes } = await supabase.from('registration_codes').select('*').eq('school_id', userProfile.school_id);
            
            let html = `<div class="grid gap-4">`;
            codes.forEach(c => {
                html += `
                <div class="flex justify-between items-center p-6 bg-white/5 rounded-2xl border border-white/5">
                    <div>
                        <p class="text-xs opacity-50 uppercase font-bold tracking-widest">${c.role}</p>
                        <p class="text-xl font-mono text-indigo-400">${c.code}</p>
                    </div>
                    <button onclick="deleteCode('${c.code}')" class="text-red-400 p-2 hover:bg-red-400/10 rounded-lg"><i data-lucide="trash-2"></i></button>
                </div>`;
            });
            document.getElementById('view-content').innerHTML = html + `</div>`;
            lucide.createIcons();
        }

        async function generateNewCode() {
            const role = prompt("Enter role for this code (teacher/manager):", "teacher");
            if (role !== 'teacher' && role !== 'manager') return alert("Invalid role");
            
            const code = 'LM-' + Math.random().toString(36).substring(2, 8).toUpperCase();
            await supabase.from('registration_codes').insert({
                code: code,
                school_id: userProfile.school_id,
                role: role
            });
            renderCodes();
        }

        async function deleteCode(code) {
            if (confirm("Delete this code?")) {
                await supabase.from('registration_codes').delete().eq('code', code);
                renderCodes();
            }
        }

        function renderDashboard() {
            document.getElementById('view-title').innerText = "Dashboard";
            document.getElementById('view-actions').innerHTML = "";
            document.getElementById('view-content').innerHTML = `
                <div class="flex flex-col items-center justify-center h-full opacity-20">
                    <i data-lucide="calendar" class="w-20 h-20 mb-4"></i>
                    <p>Select a class to view timetable</p>
                </div>
            `;
            lucide.createIcons();
        }

        async function signOut() {
            await supabase.auth.signOut();
            location.reload();
        }

        window.onload = checkUser;
        lucide.createIcons();
    </script>
</body>
</html>
