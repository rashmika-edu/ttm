<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumina School TTM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --glass: rgba(255, 255, 255, 0.7); --glass-border: rgba(255, 255, 255, 0.3); }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-panel { 
            background: var(--glass); 
            backdrop-filter: blur(12px); 
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        .sidebar-glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(15px); }
        .footer-text { font-size: 0.75rem; font-weight: 500; letter-spacing: 0.05em; }
    </style>
</head>
<body class="text-slate-900 overflow-hidden">

    <div id="auth-screen" class="fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md rounded-3xl p-8 text-center">
            <div class="mb-6">
                <i data-lucide="sparkles" class="w-12 h-12 text-indigo-600 mx-auto mb-2"></i>
                <h1 class="text-3xl font-bold text-slate-800">Lumina TTM</h1>
                <p class="text-slate-500">Intelligent School Scheduling</p>
            </div>
            
            <div class="space-y-4" id="auth-form-container">
                <input type="email" id="email" placeholder="Email" class="w-full p-3 rounded-xl border bg-white/50 focus:ring-2 focus:ring-indigo-500 outline-none">
                <input type="password" id="password" placeholder="Password" class="w-full p-3 rounded-xl border bg-white/50 focus:ring-2 focus:ring-indigo-500 outline-none">
                <button onclick="handleLogin()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition">Sign In</button>
            </div>
            
            <p class="mt-8 footer-text text-slate-400">© Developed by K.A.V.Rashmika</p>
        </div>
    </div>

    <div id="app" class="flex h-screen hidden">
        <aside class="w-72 sidebar-glass text-white flex flex-col">
            <div class="p-8 border-b border-white/10">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="layers" class="text-indigo-400"></i> Lumina TTM
                </h2>
                <p id="school-label" class="text-xs text-indigo-300 mt-1 opacity-70"></p>
            </div>

            <nav class="flex-1 p-6 space-y-2 overflow-y-auto" id="nav-items">
                </nav>

            <div class="p-6 border-t border-white/10">
                <button onclick="logout()" class="flex items-center gap-3 text-slate-400 hover:text-white transition w-full">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Logout
                </button>
                <div class="mt-4 footer-text text-white/30">© Developer by K.A.V.Rashmika</div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col p-8 overflow-hidden">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h3 id="view-title" class="text-2xl font-bold text-white">Dashboard</h3>
                    <div id="role-tag" class="inline-block px-2 py-0.5 bg-white/20 rounded text-[10px] text-white uppercase mt-1"></div>
                </div>
                <div id="header-actions"></div>
            </header>

            <div id="main-content" class="glass-panel flex-1 rounded-3xl p-8 overflow-y-auto">
                </div>
            
            <div class="mt-4 text-center footer-text text-white/50">© Developer by K.A.V.Rashmika</div>
        </main>
    </div>

    <div id="period-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[200] hidden items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md rounded-3xl p-8">
            <h3 class="text-xl font-bold mb-4">Edit Timetable Slot</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Teacher</label>
                    <select id="select-teacher" class="w-full p-2 rounded-lg border mt-1"></select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Subject</label>
                    <select id="select-subject" class="w-full p-2 rounded-lg border mt-1"></select>
                </div>
                <div id="conflict-error" class="hidden p-3 bg-red-100 text-red-600 text-xs rounded-lg border border-red-200">
                    ⚠️ This teacher is already assigned to another class at this time!
                </div>
                <div class="flex gap-2">
                    <button onclick="closeModal()" class="flex-1 py-2 bg-slate-200 rounded-lg font-bold">Cancel</button>
                    <button onclick="saveTimetableEntry()" class="flex-1 py-2 bg-indigo-600 text-white rounded-lg font-bold">Update</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://yybyyiyrquxtnczrbvgb.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Kjio-fMoDlUy5Oc0dvbH6g_HMqBX9qM';
        const supabase = exports.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let userProfile = null;
        let schoolData = null;
        let teachersList = [];

        // --- AUTH ---
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) return alert(error.message);
            
            loadSession();
        }

        async function loadSession() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return;

            const { data: profile } = await supabase.from('profiles').select('*, schools(*)').eq('id', user.id).single();
            userProfile = profile;
            schoolData = profile.schools;

            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('school-label').innerText = schoolData.name;
            document.getElementById('role-tag').innerText = profile.role;
            
            loadNav();
            switchView('dashboard');
        }

        function loadNav() {
            const nav = document.getElementById('nav-items');
            nav.innerHTML = `
                <button onclick="switchView('dashboard')" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-white/10 transition">
                    <i data-lucide="home"></i> Dashboard
                </button>
            `;
            if (userProfile.role !== 'teacher') {
                nav.innerHTML += `
                    <button onclick="switchView('manage-periods')" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-white/10 transition">
                        <i data-lucide="clock"></i> Period Times
                    </button>
                `;
            }
            lucide.createIcons();
        }

        // --- TIMETABLE LOGIC & CONFLICT DETECTION ---
        async function saveTimetableEntry() {
            const teacher_id = document.getElementById('select-teacher').value;
            const subject = document.getElementById('select-subject').value;
            const errorBox = document.getElementById('conflict-error');
            
            // Check for conflicts in the database
            const { data: conflict } = await supabase.from('timetable')
                .select('*')
                .eq('school_id', schoolData.id)
                .eq('day_index', currentSlot.day)
                .eq('period_id', currentSlot.periodId)
                .eq('teacher_id', teacher_id)
                .neq('id', currentSlot.existingId || '00000000-0000-0000-0000-000000000000') // ignore current record
                .maybeSingle();

            if (conflict) {
                errorBox.classList.remove('hidden');
                return;
            }

            // Save if no conflict
            const { error } = await supabase.from('timetable').upsert({
                id: currentSlot.existingId || undefined,
                school_id: schoolData.id,
                grade: currentSlot.grade,
                class_name: currentSlot.className,
                day_index: currentSlot.day,
                period_id: currentSlot.periodId,
                subject: subject,
                teacher_id: teacher_id
            });

            if (error) alert(error.message);
            else {
                closeModal();
                switchView('dashboard');
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            location.reload();
        }

        // Initialize Lucide icons
        lucide.createIcons();
    </script>
</body>
</html>
