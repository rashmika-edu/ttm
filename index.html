<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduSched SL | Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-50 font-sans text-slate-900">
    <div id="app"></div>

    <script>
        // --- CONFIGURATION ---
        const SB_URL = 'https://yybyyiyrquxtnczrbvgb.supabase.co';
        const SB_KEY = 'sb_publishable_Kjio-fMoDlUy5Oc0dvbH6g_HMqBX9qM';
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        // --- APP STATE ---
        let state = {
            view: 'login', // login, register, dashboard
            user: null,
            loading: false,
            timetable: [],
            selectedGrade: '6',
            selectedClass: 'A'
        };

        // --- CORE FUNCTIONS ---
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            
            try {
                const { data, error } = await _supabase.auth.signInWithPassword({ email, password: pass });
                if (error) throw error;

                const { data: profile, error: pError } = await _supabase
                    .from('profiles').select('*').eq('id', data.user.id).single();
                
                if (pError) throw new Error("Profile not found. Contact Admin.");

                state.user = profile;
                state.view = 'dashboard';
                render();
                fetchTimetable();
            } catch (err) { alert("Login Error: " + err.message); }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const sName = document.getElementById('regSchoolName').value;
            const pName = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPass').value;
            const code = Math.random().toString(36).substring(2, 7).toUpperCase();

            try {
                // 1. Create Auth Account
                const { data: authData, error: authErr } = await _supabase.auth.signUp({ email, password: pass });
                if (authErr) throw authErr;
                if (!authData.user) throw new Error("Signup failed. Email might be in use.");

                // 2. Create School
                const { error: sErr } = await _supabase.from('schools').insert([{ code, name: sName }]);
                if (sErr) throw sErr;

                // 3. Create Profile
                const { error: pErr } = await _supabase.from('profiles').insert([{
                    id: authData.user.id, name: pName, email: email, role: 'principal', school_code: code
                }]);
                if (pErr) throw pErr;

                alert(`Success! Your School Code is: ${code}`);
                state.view = 'login';
                render();
            } catch (err) { alert("Registration Failed: " + err.message); }
        }

        async function fetchTimetable() {
            const { data, error } = await _supabase.from('timetables')
                .select('*')
                .eq('school_code', state.user.school_code)
                .eq('grade', state.selectedGrade)
                .eq('class_name', state.selectedClass);
            
            if (!error) {
                state.timetable = data;
                render();
            }
        }

        async function saveSlot(day, slotIndex) {
            if (state.user.role !== 'principal') return;
            
            const sub = prompt("Enter Subject:");
            const tea = prompt("Enter Teacher Name:");
            if (!sub) return;

            const { error } = await _supabase.from('timetables').upsert({
                school_code: state.user.school_code,
                grade: state.selectedGrade,
                class_name: state.selectedClass,
                day: day,
                slot_index: slotIndex,
                subject: sub,
                teacher_name: tea
            }, { onConflict: 'school_code, grade, class_name, day, slot_index' });

            if (error) alert(error.message);
            else fetchTimetable();
        }

        // --- UI COMPONENTS ---
        function render() {
            const root = document.getElementById('app');
            
            if (state.view === 'login') {
                root.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-6">
                        <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-md">
                            <h1 class="text-3xl font-bold mb-6 text-blue-600">EduSched Login</h1>
                            <form onsubmit="handleLogin(event)" class="space-y-4">
                                <input id="loginEmail" type="email" placeholder="Email Address" class="w-full p-4 border rounded-xl" required>
                                <input id="loginPass" type="password" placeholder="Password" class="w-full p-4 border rounded-xl" required>
                                <button type="submit" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold hover:bg-blue-700">Sign In</button>
                            </form>
                            <button onclick="state.view='register';render()" class="w-full mt-4 text-slate-500">Register New School</button>
                        </div>
                    </div>`;
            } else if (state.view === 'register') {
                root.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-6">
                        <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-md">
                            <h1 class="text-3xl font-bold mb-6 text-green-600">Register School</h1>
                            <form onsubmit="handleRegister(event)" class="space-y-3">
                                <input id="regSchoolName" placeholder="School Name" class="w-full p-3 border rounded-xl" required>
                                <input id="regName" placeholder="Principal Name" class="w-full p-3 border rounded-xl" required>
                                <input id="regEmail" type="email" placeholder="Email" class="w-full p-3 border rounded-xl" required>
                                <input id="regPass" type="password" placeholder="Password (min 6 chars)" class="w-full p-3 border rounded-xl" required>
                                <button type="submit" class="w-full bg-green-600 text-white p-4 rounded-xl font-bold">Create Account</button>
                            </form>
                            <button onclick="state.view='login';render()" class="w-full mt-4 text-slate-500">Back to Login</button>
                        </div>
                    </div>`;
            } else {
                root.innerHTML = `
                    <nav class="bg-white border-b p-4 flex justify-between items-center shadow-sm">
                        <div class="font-bold text-xl text-blue-600">EduSched | ${state.user.school_code}</div>
                        <button onclick="location.reload()" class="text-red-500 font-medium">Logout</button>
                    </nav>
                    <div class="p-6 max-w-6xl mx-auto">
                        <div class="flex gap-4 mb-8 bg-white p-4 rounded-2xl shadow-sm">
                            <select onchange="state.selectedGrade=this.value;fetchTimetable()" class="p-2 border rounded-lg">
                                ${[6,7,8,9,10,11,12,13].map(g => `<option ${state.selectedGrade == g ? 'selected':''}>${g}</option>`).join('')}
                            </select>
                            <select onchange="state.selectedClass=this.value;fetchTimetable()" class="p-2 border rounded-lg">
                                ${['A','B','C','D','E'].map(c => `<option ${state.selectedClass == c ? 'selected':''}>${c}</option>`).join('')}
                            </select>
                            <div class="ml-auto text-slate-500">Role: <span class="capitalize font-bold text-slate-800">${state.user.role}</span></div>
                        </div>
                        <div class="grid grid-cols-6 gap-2 bg-white p-4 rounded-2xl shadow-lg overflow-x-auto">
                            <div class="font-bold p-2 text-center text-slate-400 border-b">Time</div>
                            ${['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].map(d => `<div class="font-bold p-2 text-center border-b">${d}</div>`).join('')}
                            ${renderGrid()}
                        </div>
                    </div>`;
            }
            lucide.createIcons();
        }

        function renderGrid() {
            let html = '';
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            for (let i = 1; i <= 8; i++) {
                html += `<div class="p-4 border-r font-medium text-slate-400">Slot ${i}</div>`;
                days.forEach(day => {
                    const slot = state.timetable.find(s => s.day === day && s.slot_index === i);
                    html += `
                        <div onclick="saveSlot('${day}', ${i})" class="p-4 border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors h-24">
                            <div class="font-bold text-blue-800">${slot ? slot.subject : '+'}</div>
                            <div class="text-xs text-slate-500">${slot ? slot.teacher_name : 'Click to add'}</div>
                        </div>`;
                });
            }
            return html;
        }

        render();
    </script>
</body>
</html>
