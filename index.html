<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumina TTM | School Schedule Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #6366f1; --accent-hover: #4f46e5; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f8fafc; overflow: hidden; }
        
        /* Animated Background */
        .bg-glow {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 600px; height: 600px; background: radial-gradient(circle, rgba(99,102,241,0.15) 0%, rgba(2,6,23,0) 70%);
            z-index: -1; filter: blur(60px); pointer-events: none;
        }

        .glass-panel { 
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(24px); 
            border: 1px solid rgba(255,255,255,0.08); 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }

        .input-group input, .input-group select {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s ease;
        }

        .input-group input:focus, .input-group select:focus {
            border-color: var(--accent);
            background: rgba(255,255,255,0.05);
            box-shadow: 0 0 0 4px rgba(99,102,241,0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.4); }
        .btn-primary:active { transform: translateY(0); }

        .dev-signature { font-size: 10px; letter-spacing: 3px; opacity: 0.3; text-transform: uppercase; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">
    <div class="bg-glow"></div>

    <div id="auth-layer" class="w-full max-w-[440px] z-10">
        <div class="glass-panel rounded-[2.5rem] p-10 relative overflow-hidden">
            <div class="absolute -top-24 -left-24 w-48 h-48 bg-indigo-500/10 rounded-full blur-3xl"></div>
            
            <div class="text-center mb-10 relative">
                <div class="inline-flex p-3 bg-indigo-500/10 rounded-2xl mb-4">
                    <i data-lucide="shield-check" class="w-8 h-8 text-indigo-400"></i>
                </div>
                <h1 id="auth-title" class="text-3xl font-bold tracking-tight text-white">Welcome Back</h1>
                <p id="auth-subtitle" class="text-slate-400 mt-2 text-sm">Please enter your details to sign in</p>
            </div>

            <form id="auth-form" onsubmit="handleAuth(event)" class="space-y-4">
                <div id="reg-fields" class="hidden space-y-4 animate-in fade-in slide-in-from-top-4 duration-300">
                    <div class="input-group">
                        <label class="text-xs font-semibold text-slate-500 ml-1 mb-1 block">FULL NAME</label>
                        <input type="text" id="fullname" placeholder="e.g. John Doe" class="w-full p-3 rounded-xl outline-none text-white">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="input-group">
                            <label class="text-xs font-semibold text-slate-500 ml-1 mb-1 block">ROLE</label>
                            <select id="role" class="w-full p-3 rounded-xl outline-none text-white appearance-none">
                                <option value="teacher">Teacher</option>
                                <option value="manager">Manager</option>
                                <option value="principal">Principal</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="text-xs font-semibold text-amber-500 ml-1 mb-1 block">JOIN CODE</label>
                            <input type="text" id="v_code" placeholder="School ID" class="w-full p-3 rounded-xl outline-none text-amber-200 border-amber-500/20 bg-amber-500/5">
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label class="text-xs font-semibold text-slate-500 ml-1 mb-1 block">EMAIL ADDRESS</label>
                    <input type="email" id="email" required placeholder="name@school.com" class="w-full p-3 rounded-xl outline-none text-white">
                </div>

                <div class="input-group">
                    <label class="text-xs font-semibold text-slate-500 ml-1 mb-1 block">PASSWORD</label>
                    <input type="password" id="password" required placeholder="••••••••" class="w-full p-3 rounded-xl outline-none text-white">
                </div>

                <button type="submit" id="submit-btn" class="w-full btn-primary py-4 rounded-2xl font-bold text-white shadow-xl mt-6">
                    Sign In
                </button>

                <p class="text-center text-sm text-slate-500 mt-8">
                    <span id="toggle-text">Don't have an account?</span>
                    <button type="button" onclick="toggleAuthMode()" class="text-indigo-400 font-bold hover:underline ml-1">
                        <span id="toggle-btn-label">Create Account</span>
                    </button>
                </p>
            </form>
        </div>
        <div class="dev-signature mt-8 text-center">Built by K.A.V.Rashmika</div>
    </div>

    <div id="main-app" class="hidden">...</div>

    <script>
        const SB_URL = 'https://yybyyiyrquxtnczrbvgb.supabase.co';
        const SB_KEY = 'sb_publishable_Kjio-fMoDlUy5Oc0dvbH6g_HMqBX9qM';
        const supabase = window.supabase.createClient(SB_URL, SB_KEY);
        
        let isRegistering = false;

        function toggleAuthMode() {
            isRegistering = !isRegistering;
            const regFields = document.getElementById('reg-fields');
            const title = document.getElementById('auth-title');
            const subtitle = document.getElementById('auth-subtitle');
            const submitBtn = document.getElementById('submit-btn');
            const toggleText = document.getElementById('toggle-text');
            const toggleBtnLabel = document.getElementById('toggle-btn-label');

            if (isRegistering) {
                regFields.classList.remove('hidden');
                title.innerText = "Join Lumina";
                subtitle.innerText = "Start managing your school schedule";
                submitBtn.innerText = "Register Account";
                toggleText.innerText = "Already have an account?";
                toggleBtnLabel.innerText = "Sign In";
            } else {
                regFields.classList.add('hidden');
                title.innerText = "Welcome Back";
                subtitle.innerText = "Please enter your details to sign in";
                submitBtn.innerText = "Sign In";
                toggleText.innerText = "Don't have an account?";
                toggleBtnLabel.innerText = "Create Account";
            }
        }

        async function handleAuth(e) {
    e.preventDefault();
    const btn = document.getElementById('submit-btn');
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    btn.disabled = true;
    btn.innerText = "Processing...";

    try {
        if (isRegistering) {
            const fullName = document.getElementById('fullname').value;
            const role = document.getElementById('role').value;
            const vCode = document.getElementById('v_code').value;

            if (!fullName || !vCode) throw new Error("Full name and Join Code are required.");

            // 1. Verify School exists BEFORE signing up
            const { data: school, error: sError } = await supabase
                .from('schools')
                .select('id')
                .eq('name', vCode) // Or .eq('id', vCode) if using UUIDs
                .single();

            if (sError || !school) {
                console.error("School lookup error:", sError);
                throw new Error("Invalid Join Code. Make sure the school name matches exactly.");
            }

            // 2. Create User in Supabase Auth
            const { data: authData, error: authError } = await supabase.auth.signUp({ 
                email, 
                password 
            });

            if (authError) throw authError;

            // 3. Create the Profile link
            if (authData.user) {
                const { error: pError } = await supabase.from('profiles').insert([{
                    id: authData.user.id,
                    full_name: fullName,
                    role: role,
                    school_id: school.id
                }]);
                
                if (pError) {
                    console.error("Profile creation error:", pError);
                    throw new Error("User created, but profile failed. This is usually an RLS policy issue.");
                }
                
                alert("Account created successfully!");
                toggleAuthMode();
            }
        } else {
            // Login Logic
            const { error } = await supabase.signInWithPassword({ email, password });
            if (error) throw error;
            window.location.reload(); 
        }
    } catch (err) {
        alert(err.message);
    } finally {
        btn.disabled = false;
        btn.innerText = isRegistering ? "Register Account" : "Sign In";
    }
}
        lucide.createIcons();
    </script>
</body>
</html>
